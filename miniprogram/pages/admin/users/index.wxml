<!-- ç®¡ç†å‘˜ç«¯ - ç”¨æˆ·ç®¡ç† -->
<view class="page">
  <!-- æœç´¢æ  -->
  <view class="search-bar">
    <view class="search-input">
      <input placeholder="æœç´¢ç”¨æˆ·æ˜µç§°æˆ–ID" bindinput="onSearch" value="{{keyword}}" />
      <text class="search-icon">ğŸ”</text>
    </view>
    <view class="search-actions">
      <button class="diagnostic-btn" bindtap="goToDiagnostic">å¤´åƒè¯Šæ–­</button>
      <button class="refresh-btn" bindtap="forceRefresh">å¼ºåˆ¶åˆ·æ–°</button>
      <button class="create-staff-btn" bindtap="onCreateTestStaff">åˆ›å»ºå‘˜å·¥</button>
    </view>
  </view>

  <!-- è§’è‰²ç­›é€‰ -->
  <view class="role-filter">
    <scroll-view scroll-x="{{true}}" class="role-scroll">
      <view class="role-btn {{!roleFilter ? 'active' : ''}}" bindtap="onRoleFilter" data-role="">å…¨éƒ¨</view>
      <view class="role-btn {{roleFilter === 'Boss' ? 'active' : ''}}" bindtap="onRoleFilter" data-role="Boss">è€æ¿</view>
      <view class="role-btn {{roleFilter === 'Staff' ? 'active' : ''}}" bindtap="onRoleFilter" data-role="Staff">å‘˜å·¥</view>
      <view class="role-btn {{roleFilter === 'Admin' ? 'active' : ''}}" bindtap="onRoleFilter" data-role="Admin">ç®¡ç†å‘˜</view>
      <view class="role-btn {{roleFilter === 'SuperAdmin' ? 'active' : ''}}" bindtap="onRoleFilter" data-role="SuperAdmin">è¶…çº§ç®¡ç†å‘˜</view>
    </scroll-view>
  </view>

  <!-- ç”¨æˆ·åˆ—è¡¨ -->
  <view class="user-list" wx:if="{{!loading}}">
    <!-- ç©ºçŠ¶æ€ -->
    <view class="empty-state" wx:if="{{users.length === 0}}">
      <view class="empty-icon">ğŸ‘¥</view>
      <view class="empty-text">æš‚æ— ç”¨æˆ·æ•°æ®</view>
    </view>

    <!-- è¶…çº§ç®¡ç†å‘˜åŒº -->
    <view class="role-section" wx:if="{{groupedUsers.SuperAdmin.length > 0}}">
      <view class="section-header">
        <view class="section-title">è¶…çº§ç®¡ç†å‘˜</view>
        <view class="section-count">{{groupedUsers.SuperAdmin.length}}äºº</view>
      </view>
      <view class="user-item" wx:for="{{groupedUsers.SuperAdmin}}" wx:key="_id">
        <view class="user-avatar">
          <image wx:if="{{item.avatar}}" src="{{item.avatar}}" mode="aspectFill" class="avatar-image" />
          <text wx:else class="avatar-placeholder">ğŸ‘¤</text>
        </view>
        <view class="user-info">
          <view class="user-name-row">
            <text class="user-name">{{item.nickname || item.userId || 'ç”¨æˆ·'}}</text>
            <button wx:if="{{currentUserRole && item.canModify}}" class="action-btn role-btn inline-btn" bindtap="onChangeRole" data-user-id="{{item._id}}" data-current-role="{{item.role}}">
              ä¿®æ”¹è§’è‰²
            </button>
          </view>
          <view class="role-badge {{getRoleClass(item.role)}}">{{getRoleName(item.role)}}</view>
        </view>
        <view class="user-actions">
          <!-- é¢å¤–çš„æ“ä½œæŒ‰é’®å¯ä»¥æ”¾åœ¨è¿™é‡Œ -->
        </view>
      </view>
    </view>

    <!-- ç®¡ç†å‘˜åŒº -->
    <view class="role-section" wx:if="{{groupedUsers.Admin.length > 0}}">
      <view class="section-header">
        <view class="section-title">ç®¡ç†å‘˜</view>
        <view class="section-count">{{groupedUsers.Admin.length}}äºº</view>
      </view>
      <view class="user-item" wx:for="{{groupedUsers.Admin}}" wx:key="_id">
        <view class="user-avatar">
          <image wx:if="{{item.avatar}}" src="{{item.avatar}}" mode="aspectFill" class="avatar-image" />
          <text wx:else class="avatar-placeholder">ğŸ‘¤</text>
        </view>
        <view class="user-info">
          <view class="user-name-row">
            <text class="user-name">{{item.nickname || item.userId || 'ç”¨æˆ·'}}</text>
            <button wx:if="{{currentUserRole && item.canModify}}" class="action-btn role-btn inline-btn" bindtap="onChangeRole" data-user-id="{{item._id}}" data-current-role="{{item.role}}">
              ä¿®æ”¹è§’è‰²
            </button>
          </view>
          <view class="role-badge {{getRoleClass(item.role)}}">{{getRoleName(item.role)}}</view>
        </view>
        <view class="user-actions">
          <!-- é¢å¤–çš„æ“ä½œæŒ‰é’®å¯ä»¥æ”¾åœ¨è¿™é‡Œ -->
        </view>
      </view>
    </view>

    <!-- è€æ¿åŒº -->
    <view class="role-section" wx:if="{{groupedUsers.Boss.length > 0}}">
      <view class="section-header">
        <view class="section-title">è€æ¿</view>
        <view class="section-count">{{groupedUsers.Boss.length}}äºº</view>
      </view>
      <view class="user-item" wx:for="{{groupedUsers.Boss}}" wx:key="_id">
        <view class="user-avatar">
          <image wx:if="{{item.avatar}}" src="{{item.avatar}}" mode="aspectFill" class="avatar-image" />
          <text wx:else class="avatar-placeholder">ğŸ‘¤</text>
        </view>
        <view class="user-info">
          <view class="user-name-row">
            <text class="user-name">{{item.nickname || item.userId || 'ç”¨æˆ·'}}</text>
            <button wx:if="{{currentUserRole && item.canModify}}" class="action-btn role-btn inline-btn" bindtap="onChangeRole" data-user-id="{{item._id}}" data-current-role="{{item.role}}">
              ä¿®æ”¹è§’è‰²
            </button>
          </view>
          <view class="role-badge {{getRoleClass(item.role)}}">{{getRoleName(item.role)}}</view>
        </view>
        <view class="user-actions">
          <!-- é¢å¤–çš„æ“ä½œæŒ‰é’®å¯ä»¥æ”¾åœ¨è¿™é‡Œ -->
        </view>
      </view>
    </view>

    <!-- å‘˜å·¥åŒº -->
    <view class="role-section" wx:if="{{groupedUsers.Staff.length > 0}}">
      <view class="section-header">
        <view class="section-title">å‘˜å·¥</view>
        <view class="section-count">{{groupedUsers.Staff.length}}äºº</view>
      </view>
      <view class="user-item" wx:for="{{groupedUsers.Staff}}" wx:key="_id">
        <view class="user-avatar">
          <image wx:if="{{item.avatar}}" src="{{item.avatar}}" mode="aspectFill" class="avatar-image" />
          <text wx:else class="avatar-placeholder">ğŸ‘¤</text>
        </view>
        <view class="user-info">
          <view class="user-name-row">
            <text class="user-name">{{item.nickname || item.userId || 'ç”¨æˆ·'}}</text>
            <button wx:if="{{currentUserRole && item.canModify}}" class="action-btn role-btn inline-btn" bindtap="onChangeRole" data-user-id="{{item._id}}" data-current-role="{{item.role}}">
              ä¿®æ”¹è§’è‰²
            </button>
          </view>
          <view class="role-badge {{getRoleClass(item.role)}}">{{getRoleName(item.role)}}</view>
        </view>
        <view class="user-actions">
          <!-- é¢å¤–çš„æ“ä½œæŒ‰é’®å¯ä»¥æ”¾åœ¨è¿™é‡Œ -->
        </view>
      </view>
    </view>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
      <view class="user-stats">
        <view class="stat-item" wx:if="{{item.role === 'Boss'}}">
          <text class="stat-value">Â¥{{item.walletBalance || 0}}</text>
          <text class="stat-label">é’±åŒ…ä½™é¢</text>
        </view>
        <view class="stat-item" wx:if="{{item.role === 'Boss'}}">
          <text class="stat-value">{{item.staffCount || 0}}</text>
          <text class="stat-label">ç›´å±å‘˜å·¥</text>
        </view>
        <view class="stat-item" wx:if="{{item.role === 'Boss'}}">
          <text class="stat-value">{{item.orderCount || 0}}</text>
          <text class="stat-label">è®¢å•æ•°é‡</text>
        </view>
        <view class="stat-item" wx:if="{{item.role === 'Staff'}}">
          <text class="stat-value">{{item.totalOrders || 0}}</text>
          <text class="stat-label">æ€»è®¢å•</text>
        </view>
        <view class="stat-item" wx:if="{{item.role === 'Staff'}}">
          <text class="stat-value">{{item.totalDuration || 0}}h</text>
          <text class="stat-label">æœåŠ¡æ—¶é•¿</text>
        </view>
        <view class="stat-item" wx:if="{{item.role === 'Admin' || item.role === 'SuperAdmin'}}">
          <text class="stat-value">--</text>
          <text class="stat-label">ç®¡ç†å‘˜</text>
        </view>
        <view class="stat-item" wx:if="{{item.role === 'Admin' || item.role === 'SuperAdmin'}}">
          <text class="stat-value">--</text>
          <text class="stat-label">ç³»ç»Ÿæƒé™</text>
        </view>
      </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-state" wx:if="{{loading}}">
    <view class="loading-text">åŠ è½½ä¸­...</view>
  </view>
</view>
</view>
