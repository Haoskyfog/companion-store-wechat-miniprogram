<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="header">
    <view class="title-section">
    <view class="title">ç»‘å®šå…³ç³»ç®¡ç†</view>
      <view class="subtitle">ç®¡ç†è€æ¿ä¸å‘˜å·¥çš„ç»‘å®šå…³ç³»</view>
    </view>
    <button class="create-btn" bindtap="showCreateModal">
      <text class="create-icon">+</text>
      åˆ›å»ºç»‘å®š
    </button>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-section" wx:if="{{!loading}}">
    <view class="stat-item">
      <text class="stat-value">{{statistics.total}}</text>
      <text class="stat-label">æ€»ç»‘å®šæ•°</text>
    </view>
    <view class="stat-item">
      <text class="stat-value">{{statistics.active}}</text>
      <text class="stat-label">æœ‰æ•ˆç»‘å®š</text>
    </view>
    <view class="stat-item">
      <text class="stat-value">{{statistics.bosses}}</text>
      <text class="stat-label">è€æ¿æ•°é‡</text>
    </view>
    <view class="stat-item">
      <text class="stat-value">{{statistics.staffs}}</text>
      <text class="stat-label">å‘˜å·¥æ•°é‡</text>
    </view>
  </view>

  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-section">
    <view class="search-bar">
      <input class="search-input"
             placeholder="æœç´¢è€æ¿æˆ–å‘˜å·¥æ˜µç§°/ID"
             value="{{searchKeyword}}"
             bindinput="onSearchInput" />
      <text class="search-icon">ğŸ”</text>
    </view>
    <view class="filter-tabs">
      <view class="filter-tab {{filterType === 'all' ? 'active' : ''}}"
            bindtap="setFilterType"
            data-type="all">å…¨éƒ¨</view>
      <view class="filter-tab {{filterType === 'boss' ? 'active' : ''}}"
            bindtap="setFilterType"
            data-type="boss">æŒ‰è€æ¿</view>
      <view class="filter-tab {{filterType === 'staff' ? 'active' : ''}}"
            bindtap="setFilterType"
            data-type="staff">æŒ‰å‘˜å·¥</view>
    </view>
  </view>

  <!-- ç»‘å®šå…³ç³»åˆ—è¡¨ -->
  <view class="content" wx:if="{{!loading}}">
    <view class="binding-list" wx:if="{{filteredBindings.length > 0}}">
      <view class="binding-item" wx:for="{{filteredBindings}}" wx:key="_id">
        <!-- è€æ¿ä¿¡æ¯ -->
        <view class="user-section boss-section">
          <view class="user-avatar">
            <image wx:if="{{item.bossInfo.avatar}}" src="{{item.bossInfo.avatar}}" mode="aspectFill" class="avatar-image" />
            <text wx:else class="avatar-emoji">ğŸ‘”</text>
          </view>
          <view class="user-info">
            <text class="user-name">{{item.bossInfo.nickname}}</text>
            <text class="user-id">{{item.bossInfo.userId}}</text>
            <text class="user-role">è€æ¿</text>
          </view>
        </view>

        <!-- ç»‘å®šå…³ç³» -->
        <view class="binding-connector">
          <view class="connector-line"></view>
          <text class="connector-text">ç»‘å®š</text>
          <view class="connector-dot"></view>
        </view>

        <!-- å‘˜å·¥ä¿¡æ¯ -->
        <view class="user-section staff-section">
          <view class="user-avatar">
            <image wx:if="{{item.staffInfo.avatar}}" src="{{item.staffInfo.avatar}}" mode="aspectFill" class="avatar-image" />
            <text wx:else class="avatar-emoji">ğŸ®</text>
          </view>
          <view class="user-info">
            <text class="user-name">{{item.staffInfo.nickname}}</text>
            <text class="user-id">{{item.staffInfo.userId}}</text>
            <text class="user-role">å‘˜å·¥</text>
          </view>
        </view>

        <!-- æ“ä½œæŒ‰é’® -->
        <view class="binding-actions">
          <view class="binding-status">
            <text class="status-text {{item.status === 'active' ? 'active' : 'inactive'}}">
              {{item.status === 'active' ? 'æœ‰æ•ˆ' : 'å·²è§£ç»‘'}}
            </text>
          </view>
          <view class="binding-time">{{item.createTime}}</view>
          <view class="action-buttons">
            <button class="view-btn"
                    data-binding="{{item}}"
                    bindtap="viewBindingDetail">
              æŸ¥çœ‹
            </button>
        <button class="delete-btn"
                data-binding-id="{{item._id}}"
                data-boss-nickname="{{item.bossInfo.nickname}}"
                data-staff-nickname="{{item.staffInfo.nickname}}"
                bindtap="deleteBinding">
          è§£ç»‘
        </button>
          </view>
        </view>
      </view>
    </view>

    <view class="empty-state" wx:else>
      <view class="empty-icon">ğŸ”—</view>
      <view class="empty-title">æš‚æ— ç»‘å®šå…³ç³»</view>
      <view class="empty-desc">{{searchKeyword ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç»‘å®šå…³ç³»' : 'ç‚¹å‡»å³ä¸Šè§’åˆ›å»ºç¬¬ä¸€ä¸ªç»‘å®šå…³ç³»'}}</view>
      <button class="empty-action" wx:if="{{!searchKeyword}}" bindtap="showCreateModal">
        åˆ›å»ºç»‘å®šå…³ç³»
      </button>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading" wx:if="{{loading}}">
    <text>åŠ è½½ä¸­...</text>
  </view>
</view>

<!-- åˆ›å»ºç»‘å®šæ¨¡æ€æ¡† -->
<view class="modal-overlay {{showCreateModal ? 'visible' : ''}}" bindtap="hideModal" catchtouchmove="preventMove">
  <view class="modal-content create-modal" catchtap="preventTap" catchtouchmove="preventMove">
    <view class="modal-header">
      <text class="modal-title">åˆ›å»ºç»‘å®šå…³ç³»</text>
      <text class="modal-subtitle">é€‰æ‹©è€æ¿å’Œå‘˜å·¥å»ºç«‹ç»‘å®šå…³ç³»</text>
    </view>

    <view class="modal-body">
      <!-- è€æ¿é€‰æ‹© -->
      <view class="form-section">
        <view class="section-title">é€‰æ‹©è€æ¿</view>
        <view class="user-selector" bindtap="showBossSelector">
          <view class="selector-content" wx:if="{{!selectedBoss}}">
            <text class="selector-placeholder">ç‚¹å‡»é€‰æ‹©è€æ¿</text>
            <text class="selector-arrow">â–¼</text>
          </view>
          <view class="selected-user" wx:else>
            <view class="user-avatar">
              <image wx:if="{{selectedBoss.avatar}}" src="{{selectedBoss.avatar}}" mode="aspectFill" class="avatar-image" />
              <text wx:else class="avatar-emoji">ğŸ‘”</text>
            </view>
            <view class="user-info">
              <text class="user-name">{{selectedBoss.nickname}}</text>
              <text class="user-id">{{selectedBoss.userId}}</text>
            </view>
            <text class="change-text" catchtap="clearBossSelection">æ›´æ¢</text>
          </view>
        </view>
      </view>

      <!-- å‘˜å·¥é€‰æ‹© -->
      <view class="form-section">
        <view class="section-title">é€‰æ‹©å‘˜å·¥</view>
        <view class="user-selector" bindtap="showStaffSelector">
          <view class="selector-content" wx:if="{{!selectedStaff}}">
            <text class="selector-placeholder">ç‚¹å‡»é€‰æ‹©å‘˜å·¥</text>
            <text class="selector-arrow">â–¼</text>
          </view>
          <view class="selected-user" wx:else>
            <view class="user-avatar">
              <image wx:if="{{selectedStaff.avatar}}" src="{{selectedStaff.avatar}}" mode="aspectFill" class="avatar-image" />
              <text wx:else class="avatar-emoji">ğŸ®</text>
            </view>
            <view class="user-info">
              <text class="user-name">{{selectedStaff.nickname}}</text>
              <text class="user-id">{{selectedStaff.userId}}</text>
            </view>
            <text class="change-text" catchtap="clearStaffSelection">æ›´æ¢</text>
          </view>
        </view>
      </view>

      <!-- ç»‘å®šè¯´æ˜ -->
      <view class="binding-info" wx:if="{{selectedBoss && selectedStaff}}">
        <view class="info-item">
          <text class="info-icon">ğŸ“‹</text>
          <text class="info-text">ç»‘å®šåï¼Œ{{selectedStaff.nickname}}å¯ä»¥ä¸º{{selectedBoss.nickname}}åˆ›å»ºè®¢å•</text>
        </view>
        <view class="info-item">
          <text class="info-icon">ğŸ”—</text>
          <text class="info-text">è€æ¿å¯ä»¥æŸ¥çœ‹å’Œç®¡ç†è¯¥å‘˜å·¥çš„è®¢å•</text>
        </view>
      </view>
    </view>

    <view class="modal-footer">
      <button class="cancel-btn" bindtap="hideModal">å–æ¶ˆ</button>
      <button class="confirm-btn {{selectedBoss && selectedStaff ? 'active' : 'disabled'}}"
              bindtap="createBinding"
              disabled="{{!selectedBoss || !selectedStaff}}">
        åˆ›å»ºç»‘å®š
      </button>
    </view>
  </view>
</view>

<!-- è€æ¿é€‰æ‹©å™¨ -->
<view class="selector-modal {{showBossSelector ? 'visible' : ''}}" bindtap="hideBossSelector">
  <view class="selector-content" catchtap="preventTap">
    <view class="selector-header">
      <text class="selector-title">é€‰æ‹©è€æ¿</text>
    </view>
    <scroll-view scroll-y="{{true}}" class="selector-list">
      <view class="user-item"
            wx:for="{{bossList}}"
            wx:key="_openid"
            data-user="{{item}}"
            catchtap="selectBoss">
        <view class="user-avatar">
          <image wx:if="{{item.avatar}}" src="{{item.avatar}}" mode="aspectFill" class="avatar-image" />
          <text wx:else class="avatar-emoji">ğŸ‘”</text>
        </view>
        <view class="user-info">
          <text class="user-name">{{item.nickname}}</text>
          <text class="user-id">{{item.userId}}</text>
        </view>
        <text class="select-icon" wx:if="{{selectedBoss && selectedBoss._openid === item._openid}}">âœ“</text>
      </view>
    </scroll-view>
  </view>
</view>

<!-- å‘˜å·¥é€‰æ‹©å™¨ -->
<view class="selector-modal {{showStaffSelector ? 'visible' : ''}}" bindtap="hideStaffSelector">
  <view class="selector-content" catchtap="preventTap">
    <view class="selector-header">
      <text class="selector-title">é€‰æ‹©å‘˜å·¥</text>
    </view>
    <scroll-view scroll-y="{{true}}" class="selector-list">
      <view class="user-item"
            wx:for="{{staffList}}"
            wx:key="_openid"
            data-user="{{item}}"
            catchtap="selectStaff">
        <view class="user-avatar">
          <image wx:if="{{item.avatar}}" src="{{item.avatar}}" mode="aspectFill" class="avatar-image" />
          <text wx:else class="avatar-emoji">ğŸ®</text>
        </view>
        <view class="user-info">
          <text class="user-name">{{item.nickname}}</text>
          <text class="user-id">{{item.userId}}</text>
        </view>
        <text class="select-icon" wx:if="{{selectedStaff && selectedStaff._openid === item._openid}}">âœ“</text>
      </view>
    </scroll-view>
  </view>
</view>