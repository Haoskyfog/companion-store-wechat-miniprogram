# Sonnet陪玩店小程序

<div align="center">

![版本](https://img.shields.io/badge/版本-v2.0-blue)
![框架](https://img.shields.io/badge/框架-微信小程序-green)
![语言](https://img.shields.io/badge/语言-TypeScript-blue)
![云开发](https://img.shields.io/badge/云开发-微信云开发-orange)

一个专业的游戏陪玩服务管理平台

[功能介绍](#功能介绍) • [快速开始](#快速开始) • [用户指南](./USER_GUIDE.md) • [技术文档](#技术文档)

</div>

---

## 📖 项目简介

Sonnet陪玩店是一个基于微信小程序云开发的游戏陪玩服务管理系统，实现了老板（客户）、员工（陪玩）、管理员三端分离的业务模式。

### 核心特色

- 🎯 **三端分离架构**：老板端、员工端、管理员端独立运营
- 💎 **VIP等级体系**：11级VIP体系，专属主线故事
- 📊 **完整的数据统计**：实时业务数据和排行榜
- 🎨 **现代化UI设计**：亚克力玻璃效果、渐变色、流畅动画
- ☁️ **云开发架构**：无需服务器，开箱即用
- 🔒 **严格权限控制**：角色分离，安全可靠

---

## 🎯 功能介绍

### 老板端功能

| 功能模块 | 说明 |
|---------|------|
| 🏠 **主页** | 轮播公告、生日祝福、相册精选 |
| ⭐ **推荐** | 优质员工推荐、搜索筛选 |
| 👤 **我的** | 个人信息、VIP等级、钱包余额、直属员工 |
| 📋 **订单管理** | 查看、确认、支付订单 |
| 🔄 **更换申请** | 申请更换直属员工 |

### 员工端功能

| 功能模块 | 说明 |
|---------|------|
| 📝 **创建订单** | 为绑定老板创建服务订单 |
| 📋 **报备管理** | 提交工作报备，上传截图 |
| 📊 **排行榜** | 查看员工排名和统计 |
| 👤 **个人资料** | 编辑头像、昵称、标签 |
| 📖 **订单记录** | 查看订单状态和历史 |

### 管理员端功能

| 功能模块 | 说明 |
|---------|------|
| 📊 **数据仪表板** | 用户、订单、流水统计 |
| 👥 **用户管理** | 角色设置、绑定关系 |
| ✅ **审核中心** | 报备审核、更换申请审核 |
| 📝 **内容管理** | 轮播图、公告、推荐配置 |
| 💰 **老板充值** | 钱包余额管理 |
| 📋 **订单管理** | 查看所有订单，处理客诉 |

---

## 🚀 快速开始

### 环境要求

- 微信开发者工具（最新版本）
- 微信小程序账号
- 微信云开发环境

### 安装步骤

#### 1. 克隆项目

```bash
git clone [项目地址]
cd miniprogram-9
```

#### 2. 配置云开发环境

1. 打开微信开发者工具
2. 导入项目
3. 在云开发控制台创建环境（或使用现有环境）
4. 记录环境ID：`cloud1-7g62s1bob33a0a2c`

#### 3. 创建数据库集合

在云开发控制台 → 数据库中，创建以下集合：

- ✅ `users` - 用户表
- ✅ `orders` - 订单表
- ✅ `reports` - 报备表
- ✅ `bindings` - 绑定关系表
- ✅ `roleChangeRequests` - 更换申请表
- ✅ `content` - 内容管理表
- ✅ `rankings` - 排行榜表
- ✅ `recharge_records` - 充值记录表

**数据库权限设置**：
```json
{
  "read": true,
  "write": false
}
```

详细结构请参考：[数据库文档](./database.md)

#### 4. 配置云存储权限

在云开发控制台 → 存储 → 权限设置：

```json
{
  "read": true,
  "write": false
}
```

这样可以确保云存储的图片能正常显示。

#### 5. 部署云函数

右键点击以下云函数目录，选择"上传并部署：云端安装依赖"：

**必须部署的云函数**：
- ✅ `getUserInfo` - 获取用户信息
- ✅ `createOrder` - 创建订单
- ✅ `confirmOrder` - 确认订单
- ✅ `getOrders` - 获取订单列表
- ✅ `submitReport` - 提交报备
- ✅ `auditReport` - 审核报备
- ✅ `getReports` - 获取报备列表
- ✅ `updateUserRole` - 更新用户角色
- ✅ `manageBindings` - 管理绑定关系
- ✅ `manageUsers` - 管理用户
- ✅ `manageWallet` - 钱包管理
- ✅ `getContent` - 获取内容
- ✅ `updateContent` - 更新内容
- ✅ `getStatistics` - 获取统计数据
- ✅ `getRankings` - 获取排行榜
- ✅ `getTotalRecharge` - 获取充值总额
- ✅ `updateUserInfo` - 更新用户信息

#### 6. 创建第一个管理员

1. 使用任意微信账号登录小程序
2. 在云开发控制台 → 数据库 → `users` 集合中找到你的用户记录
3. 手动修改 `role` 字段为 `SuperAdmin`
4. 重新进入小程序，即可看到管理员界面

#### 7. 初始化数据（可选）

运行测试脚本初始化测试数据：
```bash
# 在微信开发者工具的云开发控制台中运行
node database-init.js
```

---

## 📁 项目结构

```
miniprogram-9/
├── miniprogram/                    # 小程序前端
│   ├── pages/                      # 页面目录
│   │   ├── boss/                   # 老板端页面
│   │   │   ├── home/              # 主页
│   │   │   ├── recommend/         # 推荐页
│   │   │   ├── profile/           # 我的
│   │   │   ├── orders/            # 订单列表
│   │   │   └── ...
│   │   ├── staff/                  # 员工端页面
│   │   │   ├── create-order/     # 创建订单
│   │   │   ├── report/            # 提交报备
│   │   │   ├── reports/           # 报备记录
│   │   │   ├── ranking/           # 排行榜
│   │   │   └── ...
│   │   ├── admin/                  # 管理员端页面
│   │   │   ├── dashboard/         # 仪表板
│   │   │   ├── users/             # 用户管理
│   │   │   ├── audit/             # 审核中心
│   │   │   ├── content/           # 内容管理
│   │   │   ├── orders/            # 订单管理
│   │   │   └── ...
│   │   ├── profile/                # 公共页面
│   │   └── auth/                   # 认证页面
│   ├── custom-tab-bar/             # 自定义TabBar
│   ├── utils/                      # 工具函数
│   ├── app.ts                      # 入口文件
│   └── app.json                    # 配置文件
├── cloudfunctions/                 # 云函数
│   ├── getUserInfo/               # 用户信息
│   ├── createOrder/               # 创建订单
│   ├── confirmOrder/              # 确认订单
│   ├── getOrders/                 # 获取订单
│   ├── submitReport/              # 提交报备
│   ├── auditReport/               # 审核报备
│   ├── getReports/                # 获取报备
│   ├── manageBindings/            # 绑定管理
│   ├── manageUsers/               # 用户管理
│   ├── manageWallet/              # 钱包管理
│   ├── getContent/                # 获取内容
│   ├── updateContent/             # 更新内容
│   ├── getStatistics/             # 统计数据
│   └── ...
├── docs/                           # 文档目录
│   ├── prd.md                     # 产品需求文档
│   ├── database.md                # 数据库文档
│   ├── USER_GUIDE.md              # 用户使用指南
│   └── README.md                  # 项目说明
├── prototype/                      # 原型页面
└── package.json                    # 项目配置
```

---

## 🎨 技术架构

### 前端技术

- **框架**: 微信小程序原生框架
- **语言**: TypeScript
- **UI设计**: 
  - 亚克力玻璃效果（Glassmorphism）
  - 渐变色系统
  - 流畅动画
  - 响应式布局

### 后端技术

- **云开发**: 微信云开发
- **云函数**: Node.js
- **数据库**: 云数据库（NoSQL）
- **云存储**: 图片和文件存储

### 核心特性

1. **三端分离**
   - 老板端：查看推荐、确认订单
   - 员工端：创建订单、提交报备
   - 管理员端：用户管理、内容管理、审核功能

2. **权限控制**
   - 基于角色的权限系统
   - 严格的数据访问控制
   - 云函数权限验证

3. **数据安全**
   - 云函数后端验证
   - 数据库权限规则
   - 敏感操作日志记录

4. **性能优化**
   - 图片批量转换
   - 分页加载
   - 下拉刷新
   - 懒加载

---

## 🔧 核心业务逻辑

### 订单流程

```
员工创建订单 → 老板确认并支付 → 订单完成
     ↓               ↓              ↓
  待确认          已确认          已完成
```

**详细流程**：
1. **员工**选择已绑定的老板，填写订单信息（游戏、时长、金额等）
2. **老板**收到订单，查看详情
3. **老板**点击"确认并支付"：
   - 系统检查钱包余额
   - 扣除订单金额
   - 增加VIP消费总额
   - 订单状态变为"已完成"
4. 或**老板**点击"拒绝"，订单取消

### 报备流程

```
员工提交报备 → 管理员审核 → 审核结果
     ↓               ↓            ↓
  待审核          通过/驳回      完成
```

**详细流程**：
1. **员工**选择任意老板，填写报备信息
2. **员工**可选上传订单截图（最多3张）
3. **管理员**在审核中心查看报备
4. **管理员**点击"通过"或"驳回"
5. **员工**在报备记录中查看审核结果

### 绑定关系管理

```
管理员创建绑定 → 老板 ↔ 员工 → 一对多关系
```

**规则**：
- 只有管理员可以创建/删除绑定
- 一个老板可以绑定多个员工
- 一个员工可以被多个老板绑定
- 员工只能为绑定的老板创建订单
- 员工可以为任意老板提交报备

---

## 💡 使用场景

### 场景1：员工接单流程

1. 员工在外部平台（比心、闪电鱼等）接到老板的订单
2. 服务完成后，员工在小程序中创建订单记录
3. 老板确认服务并支付
4. 员工提交报备，上传订单截图
5. 管理员审核报备
6. 数据进入统计和排行榜

### 场景2：老板消费流程

1. 老板浏览推荐页，查看员工信息
2. 在外部平台联系员工并下单
3. 服务完成后，在小程序中确认员工创建的订单
4. 系统自动扣款并更新VIP等级
5. 查看消费记录和VIP故事

### 场景3：管理员运营流程

1. 查看仪表板，了解业务概况
2. 审核员工提交的报备
3. 处理老板的更换申请
4. 更新主页轮播图和公告
5. 配置推荐员工
6. 为老板充值

---

## 🎨 设计亮点

### UI/UX设计

1. **亚克力玻璃效果（Glassmorphism）**
   - 半透明背景
   - 毛玻璃模糊
   - 光泽动画效果

2. **渐变色系统**
   - 紫色系：`#7c3aed` → `#3b82f6` → `#06b6d4`
   - 温暖色：`#dc2626` → `#ea580c` → `#f59e0b`
   - 清新色：`#10b981` → `#14b8a6` → `#06b6d4`

3. **微交互动画**
   - 卡片悬浮阴影
   - 按钮点击缩放
   - 光泽扫描动画
   - 雪花飘落（可选）

4. **视觉层次**
   - 明确的信息架构
   - 合理的留白
   - 统一的圆角和间距

### VIP故事系统

每个VIP等级都有专属的诗意故事：
- VIP1（¥0）：初入花园
- VIP2（¥666）：琴键轻舞
- VIP3（¥1,888）：夜空繁星
- ...
- VIP11（¥500,000）：永恒传说

---

## 📊 数据结构

### 核心数据表

| 集合名 | 说明 | 主要字段 |
|-------|------|---------|
| `users` | 用户表 | role, nickname, avatar, walletBalance, totalConsumption |
| `orders` | 订单表 | staffId, bossId, amount, status, paymentStatus |
| `reports` | 报备表 | staffId, bossId, images, status |
| `bindings` | 绑定表 | bossId, staffId, status |
| `content` | 内容表 | type, title, images, status |

详细结构请查看：[数据库文档](./database.md)

---

## 🔐 权限说明

### 角色权限矩阵

| 功能 | 老板 | 员工 | 管理员 |
|------|-----|------|--------|
| 查看推荐 | ✅ | ✅ | ✅ |
| 创建订单 | ❌ | ✅ | ✅ |
| 确认订单 | ✅ | ❌ | ✅ |
| 提交报备 | ❌ | ✅ | ✅ |
| 审核报备 | ❌ | ❌ | ✅ |
| 绑定用户 | ❌ | ❌ | ✅ |
| 修改角色 | ❌ | ❌ | ✅ |
| 内容管理 | ❌ | ❌ | ✅ |
| 老板充值 | ❌ | ❌ | ✅ |

### 数据访问控制

- **老板**：只能查看自己的订单和绑定员工
- **员工**：只能查看自己创建的订单和报备
- **管理员**：可以查看所有数据

---

## 🛠️ 技术实现细节

### 图片处理方案

**问题**：云存储的 `cloud://` URL 无法直接在 `<image>` 组件中显示

**解决方案**：
1. **在云函数中转换**（推荐）：
   - 云函数返回数据前，批量调用 `getTempFileURL`
   - 将 `cloud://` 转换为 `https://` 临时URL
   - 前端直接使用转换后的URL

2. **严格验证**：
   - 只接受 `status === 0` 的转换结果
   - 转换失败的图片直接移除
   - 确保传给WXML的URL都是 `https://` 格式

**实现代码**（在云函数中）：
```javascript
const cloudFileIds = images.filter(img => img.startsWith('cloud://'))
const tempResult = await cloud.getTempFileURL({ fileList: cloudFileIds })

const urlMap = {}
tempResult.fileList.forEach(file => {
  if (file.status === 0 && file.tempFileURL) {
    urlMap[file.fileID] = file.tempFileURL
  }
})

const convertedImages = images
  .map(img => img.startsWith('cloud://') ? urlMap[img] : img)
  .filter(img => img && img.startsWith('https://'))
```

### 数据库查询优化

**问题**：`staffId`、`bossId` 存储的是 `_openid`，不是文档 `_id`

**错误示例**：
```javascript
// ❌ 错误 - doc() 是通过文档ID查询
db.collection('users').doc(staffId).get()
```

**正确示例**：
```javascript
// ✅ 正确 - where() 通过字段查询
db.collection('users').where({ _openid: staffId }).get()
```

### 金额和流水计算

**订单金额**：
- 员工创建订单时填写
- 类型必须是 `number`
- 老板确认时扣除相应金额

**总流水计算**：
```javascript
// 查询所有已支付订单
const paidOrders = await db.collection('orders')
  .where({ paymentStatus: 'paid' })
  .get()

// 累加真实金额
const totalRevenue = paidOrders.data.reduce(
  (sum, order) => sum + (parseFloat(order.amount) || 0), 
  0
)
```

---

## 🐛 常见问题排查

### 问题1: 员工创建订单时选择不到老板

**原因**：数据库查询方式错误

**解决**：确保使用 `.where({ _openid: bossId })` 而不是 `.doc(bossId)`

---

### 问题2: 订单确认时扣款0元

**原因**：订单金额字段为0或类型错误

**解决**：
1. 检查员工创建订单时是否正确填写金额
2. 确保金额字段类型为 `number`
3. 查看云函数日志确认金额值

---

### 问题3: 报备图片显示404

**原因**：云存储URL未转换或权限问题

**解决**：
1. 检查云存储权限设置（read: true）
2. 重新部署 `getReports` 云函数
3. 确保图片在云函数中已转换为 https://

---

### 问题4: 总流水计算错误

**原因**：订单金额字段有问题或计算逻辑错误

**解决**：
1. 检查已支付订单的 `amount` 字段
2. 确保计算逻辑使用 `parseFloat(order.amount)`
3. 查看 `getStatistics` 云函数日志

---

### 问题5: 报备审核后不消失

**原因**：状态更新失败或前端使用了旧数据

**解决**：
1. 检查 `auditReport` 云函数日志
2. 确认数据库中的 `status` 字段已更新
3. 前端重新加载列表，不使用 `this.data.reports` 过滤

---

## 📚 文档索引

- 📖 [用户使用指南](./USER_GUIDE.md) - 详细的操作说明（三端）
- 📋 [产品需求文档](./prd.md) - 业务逻辑和规则
- 🗄️ [数据库文档](./database.md) - 数据结构说明
- 🧪 [测试指南](../TEST_INSTRUCTIONS.md) - 功能测试说明

---

## 🔄 更新日志

### v2.0 (2025-12-16)

**重大修复**：
- ✅ 修复所有数据库查询方式（`.where({ _openid })` vs `.doc()`）
- ✅ 修复订单金额和总流水计算
- ✅ 修复报备图片显示问题
- ✅ 修复审核后数据不刷新问题

**功能优化**：
- ✅ 老板确认订单时自动支付
- ✅ 管理员端订单分类简化（全部、已支付、已取消）
- ✅ 员工端订单分类简化（全部、已确认、已取消）
- ✅ 员工报备可选择所有老板（不限于绑定）
- ✅ 推荐页面现代化设计优化

**UI改进**：
- ✅ 老板订单列表显示员工头像
- ✅ 管理员审核页面显示完整用户信息
- ✅ 推荐页亚克力玻璃效果
- ✅ 总流水金额格式化显示

**新增功能**：
- ✅ 报备图片上传和预览
- ✅ 云存储图片自动转换
- ✅ VIP等级主线故事
- ✅ 我的直属员工展示

---

## 👥 贡献

欢迎提交 Issue 和 Pull Request！

---

## 📄 许可证

本项目仅供学习和参考使用。

---

## 📞 联系方式

如有任何问题或建议，请联系：
- 项目负责人：[您的联系方式]
- 技术支持：[技术支持联系方式]

---

**Made with ❤️ by Sonnet Team**

**最后更新**: 2025-12-16

