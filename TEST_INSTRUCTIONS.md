# 完整测试流程说明

## 测试目标
实现员工下单、老板支付、管理员审核报备的完整功能流程。

## 测试流程
1. **小陈1（员工）** 给 **团长Holo（老板）** 发送20元订单
2. **老板** 在主页的"我的订单"里收到订单，有支付按钮
3. 点击支付，扣除钱包余额，VIP消费总额增加
4. 管理员端总流水增加20元
5. **小陈1** 提交报备，管理员审核通过
6. 管理员端审核报备消失，员工报备通过数+1

## 运行测试脚本

### 方法1：管理员面板一键测试（推荐）
1. 登录管理员账号进入管理后台
2. 在仪表板中找到"启用测试"按钮（🧪图标）
3. 点击按钮确认运行测试
4. 系统会自动创建测试数据并执行完整流程

### 方法2：在微信开发者工具中运行
1. 打开微信开发者工具
2. 进入云开发控制台
3. 在控制台中复制粘贴 `test-complete-flow.js` 的内容
4. 运行脚本

### 方法3：使用现有测试脚本
运行项目中的其他测试脚本：
```bash
# 初始化测试数据
node init-test-data.js

# 运行完整测试
node test-complete-flow.js  # 在微信开发者工具控制台中运行
```

## 已实现的功能

### ✅ 已完成的修改

1. **统计功能改进**
   - 修改 `getStatistics/index.js`，总流水现在基于实际支付金额计算
   - 不再是固定50元×订单数量

2. **VIP消费总额功能**
   - 在 `confirmOrder/index.js` 中，支付时同时增加用户消费总额
   - VIP等级页面显示真实的消费总额

3. **员工报备通过数统计**
   - 在 `auditReport/index.js` 中，审核通过时增加员工的报备通过数
   - 员工资料页显示报备通过数统计

4. **前端显示更新**
   - 员工资料页添加了报备通过数显示
   - VIP页面显示真实的消费总额

5. **完整测试脚本**
   - 创建了 `test-complete-flow.js`，模拟完整业务流程
   - 包含用户创建、绑定、订单、支付、报备、审核等步骤

## 测试数据

测试脚本会创建以下测试用户：
- **小陈1（员工）**: `staff_test_chen1` - 员工角色
- **团长Holo（老板）**: `boss_test_holo` - 老板角色，初始余额100元
- **超级管理员**: `admin_test_super` - 管理员角色

## 验证方法

### 老板端验证
1. 登录老板账号（团长Holo）
2. 查看"我的订单" - 应该看到20元订单，可点击支付
3. 点击支付后，查看VIP页面 - 消费总额应为20元
4. 查看钱包余额 - 应从100元变为80元

### 管理员端验证
1. 登录管理员账号
2. 查看数据统计 - 总流水应显示20元
3. 查看审核中心 - 应该能看到员工的报备记录
4. 审核通过报备后，该报备应消失

### 员工端验证
1. 登录员工账号（小陈1）
2. 查看个人资料 - 报备通过数应显示1
3. 可以继续创建订单和提交报备

## 注意事项

1. **云函数部署**: 确保所有修改的云函数已部署到云端
2. **数据库权限**: 测试脚本需要在有数据库写入权限的环境中运行
3. **测试数据清理**: 测试完成后可手动删除测试数据

## 新增功能说明

### 管理员端测试按钮
- 在管理员仪表板中新增"启用测试"按钮（🧪图标）
- 点击后调用 `runCompleteTest` 云函数自动执行完整测试流程
- 无需手动复制代码到控制台，操作更便捷

## 文件清单

- `test-complete-flow.js` - 完整测试脚本（本地版本）
- `cloudfunctions/runCompleteTest/index.js` - 云函数版本的测试脚本
- `cloudfunctions/runCompleteTest/package.json` - 云函数配置
- `cloudfunctions/getStatistics/index.js` - 修改的总流水计算
- `cloudfunctions/confirmOrder/index.js` - 添加消费总额统计
- `cloudfunctions/auditReport/index.js` - 添加报备通过数统计
- `miniprogram/pages/admin/dashboard/index.ts` - 添加测试按钮和处理逻辑
- `miniprogram/pages/staff/profile/index.ts` - 添加报备统计显示
- `miniprogram/pages/staff/profile/index.wxml` - 更新前端显示
